// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id                    Int       @id @default(autoincrement())
  email                 String    @unique
  password              String? // Optional for OAuth users
  name                  String
  is_active             Boolean   @default(true)
  email_verified        Boolean   @default(false)
  preferred_auth_method String    @default("jwt") // jwt, oauth2, api_key, firebase
  last_login_at         DateTime?

  // Firebase Authentication
  firebase_uid    String? @unique @map("firebase_uid")
  profile_picture String? @map("profile_picture")

  // 2FA Fields
  two_factor_enabled     Boolean   @default(false) @map("two_factor_enabled")
  two_factor_secret      String?   @map("two_factor_secret") // TOTP secret
  backup_codes           String?   @map("backup_codes") @db.Text // JSON string of backup codes
  two_factor_verified_at DateTime? @map("two_factor_verified_at")

  created_at DateTime @default(now()) @map("created_at")
  updated_at DateTime @updatedAt @map("updated_at")

  // Relations
  oauth_accounts    OAuthAccount[]
  api_keys          ApiKey[]
  refreshTokens     RefreshToken[]
  two_factor_tokens TwoFactorToken[]

  @@map("users")
}

model OAuthAccount {
  id            Int       @id @default(autoincrement())
  user_id       Int       @map("user_id")
  provider      String // google, github, facebook, etc.
  provider_id   String    @map("provider_id")
  access_token  String?   @map("access_token") @db.Text
  refresh_token String?   @map("refresh_token") @db.Text
  expires_at    DateTime? @map("expires_at")
  token_type    String?   @map("token_type")
  scope         String?
  created_at    DateTime  @default(now()) @map("created_at")
  updated_at    DateTime  @updatedAt @map("updated_at")

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([provider, provider_id])
  @@map("oauth_accounts")
}

model ApiKey {
  id           Int       @id @default(autoincrement())
  user_id      Int       @map("user_id")
  name         String
  description  String?
  key_hash     String    @unique @map("key_hash")
  prefix       String // First 8 chars for identification
  is_active    Boolean   @default(true) @map("is_active")
  last_used_at DateTime? @map("last_used_at")
  expires_at   DateTime? @map("expires_at")
  created_at   DateTime  @default(now()) @map("created_at")
  updated_at   DateTime  @updatedAt @map("updated_at")

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("api_keys")
}

model RefreshToken {
  id         Int      @id @default(autoincrement())
  user_id    Int      @map("user_id")
  token      String   @unique
  expires_at DateTime @map("expires_at")
  is_revoked Boolean  @default(false) @map("is_revoked")
  created_at DateTime @default(now()) @map("created_at")

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

model TwoFactorToken {
  id         Int      @id @default(autoincrement())
  user_id    Int      @map("user_id")
  token      String
  type       String // 'email_otp', 'sms_otp', 'backup_code'
  expires_at DateTime @map("expires_at")
  isUsed     Boolean  @default(false) @map("is_used")
  created_at DateTime @default(now()) @map("created_at")

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id, type])
  @@map("two_factor_tokens")
}

model Category {
  id          Int      @id @default(autoincrement())
  name        String
  description String?
  slug        String   @unique
  image       String?
  is_active   Boolean  @default(true)
  created_at  DateTime @default(now()) @map("created_at")
  updated_at  DateTime @updatedAt @map("updated_at")

  // Relations
  items Item[]

  @@map("categories")
}

model Item {
  id          Int      @id @default(autoincrement())
  name        String
  description String?
  price       Float
  quantity    Int      @default(0)
  category_id Int?     @map("category_id")
  is_active   Boolean  @default(true)
  created_at  DateTime @default(now()) @map("created_at")
  updated_at  DateTime @updatedAt @map("updated_at")

  // Relations
  category Category? @relation(fields: [category_id], references: [id], onDelete: Cascade)

  @@map("items")
}

// Medical Supplies Usage
model MedicalSupplyUsage {
  id Int @id @default(autoincrement())

  // Patient Information
  patient_hn      String @map("patient_hn")
  patient_name_th String @map("patient_name_th")
  patient_name_en String @map("patient_name_en")

  // Usage Details
  usage_datetime String? @map("usage_datetime")
  usage_type     String? @map("usage_type")
  purpose        String? @map("purpose")

  // Location
  department_code String? @map("department_code")

  // Personnel
  recorded_by_user_id String? @map("recorded_by_user_id")

  // Billing
  billing_status   String? @map("billing_status")
  billing_subtotal Float?  @map("billing_subtotal")
  billing_tax      Float?  @map("billing_tax")
  billing_total    Float?  @map("billing_total")
  billing_currency String? @default("THB") @map("billing_currency")

  // Timestamps
  created_at DateTime @default(now()) @map("created_at")
  updated_at DateTime @updatedAt @map("updated_at")

  // Relations
  supply_items SupplyUsageItem[]
  logs         MedicalSupplyUsageLog[]

  @@index([patient_hn])
  @@index([usage_datetime])
  @@index([department_code])
  @@index([billing_status])
  @@map("medical_supply_usages")
}

// Supply Usage Items
model SupplyUsageItem {
  id                      Int      @id @default(autoincrement())
  medical_supply_usage_id Int      @map("medical_supply_usage_id")
  
  // Supply Details (stored directly)
  supply_code     String @map("supply_code")
  supply_name     String @map("supply_name")
  supply_category String @map("supply_category")
  unit            String @map("unit")
  quantity        Int    @map("quantity")
  unit_price      Float  @map("unit_price")
  total_price     Float  @map("total_price")
  expiry_date     String? @map("expiry_date")
  
  created_at DateTime @default(now()) @map("created_at")
  updated_at DateTime @updatedAt @map("updated_at")

  // Relations
  usage MedicalSupplyUsage @relation(fields: [medical_supply_usage_id], references: [id], onDelete: Cascade)

  @@index([medical_supply_usage_id])
  @@index([supply_code])
  @@map("supply_usage_items")
}

// Medical Supplies Usage Logs
model MedicalSupplyUsageLog {
  id Int @id @default(autoincrement())

  // Reference to the usage record (nullable for error logs)
  usage_id Int? @map("usage_id")

  // Action data (JSON) - เก็บทุกอย่างใน JSON
  action Json @map("action") @db.Json

  // Timestamp
  created_at DateTime @default(now()) @map("created_at")

  // Relations (optional - for error logs without usage_id)
  usage MedicalSupplyUsage? @relation(fields: [usage_id], references: [id], onDelete: Cascade)

  @@index([usage_id])
  @@index([created_at])
  @@map("medical_supply_usages_logs")
}
